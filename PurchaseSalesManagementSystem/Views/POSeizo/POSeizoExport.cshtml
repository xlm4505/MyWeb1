@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PO Seizo Export - Fujikin</title>
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="~/lib/xlsx/xlsx.full.min.js"></script>
</head>
<body class="p-4 bg-light">

    <!-- ナビバー -->
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/Home/Menu">← Back to Menu</a>
            <span class="text-white">PO Seizo Export</span>
        </div>
    </nav>

    <div style="max-width:700px; margin-left:0; margin-right:auto;">
        <div class="card p-4">
            <form id="searchForm">

                <!-- Vendor -->
                <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">Vendor</label>
                    <div class="col-sm-4">
                        <select class="form-select" id="vendorCode"></select>
                    </div>
                    <div class="col-sm-5">
                        <input type="text" id="vendorName" class="form-control" readonly>
                    </div>
                </div>

                <!-- User Name -->
                <div class="mb-3 row">
                    <label class="col-sm-3 col-form-label">User Name</label>
                    <div class="col-sm-9">
                        <select class="form-select" id="userName"></select>
                    </div>
                </div>

                <!-- Order Status -->
                <div class="mb-3 row">
                    <label class="col-sm-3 col-form-label">Order Status</label>
                    <div class="col-sm-9">
                        <select class="form-select" id="orderStatus">
                            <option value="New" selected>New</option>
                            <option value="All">All</option>
                        </select>
                    </div>
                </div>

                <!-- PO Entry Date -->
                <div class="mb-3 row">
                    <label class="col-sm-3 col-form-label">PO Entry Date</label>
                    <div class="col-sm-9">
                        <input type="date" id="poDate" class="form-control">
                    </div>
                </div>

                <!-- Purchase Print -->
                <div class="mb-3 row">
                    <label class="col-sm-3 col-form-label">Purchase Order</label>
                    <div class="col-sm-9">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="printOption" value="Print" checked>
                            <label class="form-check-label" for="printOption">Print</label>
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label class="col-sm-10 col-form-label">※Maintenance Tbl_Vendor table if needed!</label>
                </div>

                <!-- RUN -->
                <div class="mb-3 row">
                    <div class="col-sm-12 text-end">
                        <button type="button" class="btn btn-primary" id="btnRun">RUN</button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <script>
        document.getElementById("poDate").value = new Date().toISOString().slice(0, 10);

        // Vendor プルダウン読み込み
        loadVendors();

        function loadVendors() {
            fetch("/POSeizo/GetVendors")
                .then(res => res.json())
                .then(data => {
                    const vendorSelect = document.getElementById("vendorCode");
                    vendorSelect.innerHTML = "";

                    // DB Vendor を追加
                    data.forEach(v => {
                        const opt = document.createElement("option");
                        opt.value = v.vendorNo;
                        opt.textContent = v.vendorNo;
                        opt.dataset.name = v.vendorName;
                        vendorSelect.appendChild(opt);
                    });

                    vendorSelect.selectedIndex = 1;
                    vendorSelect.dispatchEvent(new Event("change"));
                });
        }

        // VendorName 表示
        document.getElementById("vendorCode").addEventListener("change", function () {
            const selected = this.options[this.selectedIndex];
            document.getElementById("vendorName").value = selected.dataset.name || "";
        });


        // Vendor プルダウン読み込み
        loadUsers();

        function loadUsers() {
            fetch("/POSeizo/GetUser")
                .then(res => res.json())
                .then(data => {
                    const userSelect = document.getElementById("userName");
                    userSelect.innerHTML = "";

                    data.forEach(u => {
                        const opt = document.createElement("option");
                        opt.value = u.userName;
                        opt.textContent = u.userName;
                        userSelect.appendChild(opt);
                    });

                    userSelect.selectedIndex = 0;
                });
        }

        async function downloadFromGetUrl(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error("Failed to download the Excel file.");
            }

            const blob = await response.blob();
            const disposition = response.headers.get("content-disposition") || "";
            const fileNameMatch = disposition.match(/filename\*?=(?:UTF-8'')?"?([^";]+)"?/i);
            const decodedFileName = fileNameMatch ? decodeURIComponent(fileNameMatch[1]) : "PO_SeizoExport.xlsx";
            triggerDownload(blob, decodedFileName);
        }

        async function downloadFromPostUrl(url, payload) {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let errorMessage = "The print process failed.";
                try {
                    const json = await response.json();
                    if (json?.message) {
                        errorMessage = json.message;
                    }
                } catch {
                    // no-op
                }
                throw new Error(errorMessage);
            }

            const blob = await response.blob();
            const disposition = response.headers.get("content-disposition") || "";
            const fileNameMatch = disposition.match(/filename\*?=(?:UTF-8'')?"?([^";]+)"?/i);
            const decodedFileName = fileNameMatch ? decodeURIComponent(fileNameMatch[1]) : "PurchaseOrder.pdf";
            triggerDownload(blob, decodedFileName);
        }

        function triggerDownload(blob, fileName) {
            const blobUrl = URL.createObjectURL(blob);
            const anchor = document.createElement("a");
            anchor.href = blobUrl;
            anchor.download = fileName;
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
            URL.revokeObjectURL(blobUrl);
        }

        // RUN → サーバー側で必要ファイルを作成してダウンロード
        document.getElementById("btnRun").addEventListener("click", async () => {
            const vendor = document.getElementById("vendorCode").value;
            const userName = document.getElementById("userName").value;
            const orderStatus = document.getElementById("orderStatus").value;
            const poEntryDate = document.getElementById("poDate").value;
            const vendorName = document.getElementById("vendorName").value;
            const shouldPrint = document.getElementById("printOption").checked;

            let actionUrl = "";
            let checkUrl = "";
            if (vendor === "08-0000250") {
                actionUrl = "/POSeizo/ExportToExcel_TKF";
                checkUrl = "/POSeizo/CheckData_TKF";
            } else {
                actionUrl = "/POSeizo/ExportToExcel_ALL";
                checkUrl = "/POSeizo/CheckData_ALL";
            }

            try {
                const checkResponse = await fetch(checkUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        vendor: vendor,
                        userName: userName,
                        orderStatus: orderStatus,
                        poEntryDate: poEntryDate
                    })
                });

                const checkResult = await checkResponse.json();
                if (!checkResult.success) {
                    alert(checkResult.message);
                    return;
                }

                let excelUrl = `${actionUrl}?reportName=POSeizo`;
                if (vendor !== "00-0000000") {
                    excelUrl += `&vendor=${vendor}`;
                }
                excelUrl += `&userName=${encodeURIComponent(userName)}`;
                excelUrl += `&orderStatus=${orderStatus}`;
                excelUrl += `&poEntryDate=${poEntryDate}`;
                excelUrl += `&vendorName=${encodeURIComponent(vendorName)}`;

                await downloadFromGetUrl(excelUrl);

                if (shouldPrint) {
                    await downloadFromPostUrl("/POSeizo/RunPrint", {
                        vendor: vendor,
                        vendorName: vendorName,
                        userName: userName,
                        orderStatus: orderStatus,
                        poEntryDate: poEntryDate
                    });
                }
            } catch (error) {
                alert(error?.message || "A communication error has occurred.");
            }
        });
    </script>

</body>
</html>
