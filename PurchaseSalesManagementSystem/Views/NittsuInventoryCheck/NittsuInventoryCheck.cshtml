@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nittsu Inventory Check - Fujikin</title>
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="~/lib/xlsx/xlsx.full.min.js"></script>
</head>
<body class="p-4">
    <!-- ナビバー -->
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/Home/Menu">← Back to Menu</a>
            <span class="text-white">Nittsu Inventory Check</span>
        </div>
    </nav>

    <!-- アップロードフォーム -->
    <div class="card p-3">

        <label class="form-label">Select Mas Inventory Data</label>
        <input type="file" id="file1" class="form-control mb-3">

        <label class="form-label">Select Nittsu Inventory Data</label>
        <input type="file" id="file2" class="form-control mb-3">

        <!-- 選択ファイル一覧（枠付き） -->
        <div id="fileList" class="border rounded p-2 mb-3" style="min-height:60px;">
            <strong>Files Selected:</strong>
            <ul id="fileListItems" class="mb-0"></ul>
        </div>

        <!-- Compareボタン -->
        <button class="btn btn-primary" onclick="compareFiles()">Compare</button>
    </div>

    <!-- メッセージ表示 -->
    <div id="messageArea" class="mt-3 text-primary fw-bold"></div>

    <!-- チェックリスト表示 -->
    <div id="checklist" class="mt-4" style="display:none;">
        <h5>Console log</h5>
        <ul id="logList" class="list-group"></ul>
    </div>

    <script>
        // ファイル選択時に一覧を表示
        document.getElementById("file1").addEventListener("change", updateFileList);
        document.getElementById("file2").addEventListener("change", updateFileList);

        function updateFileList() {
            const fileListItems = document.getElementById("fileListItems");
            fileListItems.innerHTML = "";
            const f1 = document.getElementById("file1").files[0];
            const f2 = document.getElementById("file2").files[0];
            if (!f1 && !f2) {
                const li = document.createElement("li");
                li.textContent = "No File Selected";
                fileListItems.appendChild(li);
            } else {
                if (f1) {
                    const li = document.createElement("li");
                    li.textContent = "Mas Inventory Data: " + f1.name;
                    fileListItems.appendChild(li);
                }
                if (f2) {
                    const li = document.createElement("li");
                    li.textContent = "Nittsu Inventory Data: " + f2.name;
                    fileListItems.appendChild(li);
                }
            }
        }

        // ファイル読み込み
        function readFile(file, callback) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const workbook = XLSX.read(e.target.result, { type: "binary" });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                callback(json);
            };
            reader.readAsBinaryString(file);
        }

        // 比較処理
        function compareFiles() {
            const f1 = document.getElementById("file1").files[0];
            const f2 = document.getElementById("file2").files[0];
            const messageArea = document.getElementById("messageArea");

            if (!f1 || !f2) {
                alert("Please select both Mas and Nittsu inventory data files!");
                return;
            }

            messageArea.textContent = "Compare Start...";

            readFile(f1, function (data1) {
                readFile(f2, function (data2) {
                    const differences = [];
                    const maxLen = Math.max(data1.length, data2.length);
                    for (let i = 0; i < maxLen; i++) {
                        const row1 = data1[i] ? data1[i].join(",") : "";
                        const row2 = data2[i] ? data2[i].join(",") : "";
                        if (row1 !== row2) {
                            differences.push([i + 1, row1, row2]);
                        }
                    }

                    // ログ表示
                    const logList = document.getElementById("logList");
                    logList.innerHTML = "";
                    if (differences.length === 0) {
                        logList.innerHTML = "<li class='list-group-item'>✔ No differences found</li>";
                    } else {
                        differences.forEach(diff => {
                            const li = document.createElement("li");
                            li.className = "list-group-item";
                            li.textContent = "Row " + diff[0] + " differs";
                            logList.appendChild(li);
                        });
                    }
                    document.getElementById("checklist").style.display = "block";
                    messageArea.textContent = "Compare Complete!";

                    // Excel生成
                    const ws = XLSX.utils.aoa_to_sheet([["Row", "Mas", "NIT"], ...differences]);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Differences");
                    const filename = "CompareResult_" + new Date().toISOString().slice(0, 10) + ".xlsx";
                    XLSX.writeFile(wb, filename);
                });
            });
        }
    </script>
</body>
</html>
